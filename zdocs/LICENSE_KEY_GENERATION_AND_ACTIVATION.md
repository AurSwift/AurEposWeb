# License Key Generation and Activation Flow - Complete Technical Documentation

## Overview

This document provides a **comprehensive, detailed explanation** of how license keys are generated, how machine fingerprints are linked to license keys, and the complete activation and validation flows in the AuraSwift EPOS system.

## Table of Contents

1. [Key Concepts](#key-concepts)
2. [Database Schema](#database-schema)
3. [License Key Generation (WEB)](#license-key-generation-web)
4. [Machine Fingerprinting (DESKTOP)](#machine-fingerprinting-desktop)
5. [License Activation Flow (Complete)](#license-activation-flow-complete)
6. [License Validation Flow](#license-validation-flow)
7. [Heartbeat and Ongoing Validation](#heartbeat-and-ongoing-validation)
8. [How License Key and Machine Fingerprint are Linked](#how-license-key-and-machine-fingerprint-are-linked)
9. [Code Flow Walkthrough](#code-flow-walkthrough)

---

## Key Concepts

### The Three Core Components

1. **License Key** (Generated by WEB)

   - Unique identifier for a customer's subscription
   - Format: `AUR-PRO-V2-7A83B2D4-1F2E3D4C`
   - Generated when customer pays
   - Stored in `license_keys` table

2. **Machine Fingerprint** (Generated by DESKTOP)

   - Unique identifier for a Windows PC
   - Format: `MF2-{64 hex characters}`
   - Generated from stable hardware identifiers
   - Changes only if hardware changes significantly

3. **Activation Record** (Created by WEB)
   - Links a license key to a specific machine
   - Stored in `activations` table
   - **This is the key linkage** between license and machine

### How They Work Together

```
License Key (from web)  +  Machine Fingerprint (from desktop)
         ↓                            ↓
         └────────────────────────────┘
                      ↓
            Activation Record (in web database)
            - license_key: "AUR-PRO-V2-..."
            - machine_id_hash: "MF2-..."
            - terminal_name: "Main Terminal"
            - is_active: true
```

---

## Database Schema

### 1. License Keys Table (`license_keys`)

**Location**: `web/lib/db/schema.ts`

```typescript
export const licenseKeys = pgTable("license_keys", {
  id: uuid("id").primaryKey(),
  customerId: uuid("customer_id"), // Stripe customer
  subscriptionId: uuid("subscription_id"), // Stripe subscription
  licenseKey: varchar("license_key", { length: 50 }).unique(), // "AUR-PRO-V2-..."
  maxTerminals: integer("max_terminals").default(1), // Based on plan
  version: varchar("version", { length: 10 }).default("V2"),
  isActive: boolean("is_active").default(true),
  issuedAt: timestamp("issued_at"),
  expiresAt: timestamp("expires_at"),
  revokedAt: timestamp("revoked_at"),
  revocationReason: text("revocation_reason"),
  activationCount: integer("activation_count").default(0),
});
```

**Key Fields**:

- `license_key`: The actual license key string (unique)
- `customer_id`: Links to Stripe customer
- `max_terminals`: How many machines can activate this license
- `is_active`: Whether license is valid

### 2. Activations Table (`activations`)

**Location**: `web/lib/db/schema.ts` (lines 102-117)

```typescript
export const activations = pgTable("activations", {
  id: uuid("id").primaryKey(),
  licenseKey: varchar("license_key", { length: 50 }) // Foreign key to license_keys
    .references(() => licenseKeys.licenseKey),
  machineIdHash: varchar("machine_id_hash", { length: 128 }), // Machine fingerprint
  terminalName: varchar("terminal_name", { length: 100 }),
  firstActivation: timestamp("first_activation"),
  lastHeartbeat: timestamp("last_heartbeat"),
  isActive: boolean("is_active").default(true),
  ipAddress: inet("ip_address"),
  location: jsonb("location"), // Platform, arch, etc.
});
```

**Key Fields**:

- `license_key`: References the license key (THIS IS THE LINK!)
- `machine_id_hash`: The machine fingerprint from desktop (THIS IS THE OTHER LINK!)
- `is_active`: Whether this activation is currently active
- `last_heartbeat`: Last time desktop checked in

**This table is the BRIDGE** - it links `license_key` → `machine_id_hash`

### Example Database Records

**After customer pays and activates:**

**license_keys table**:

```
id: "123e4567-e89b-12d3-a456-426614174000"
license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"
customer_id: "cus_ABC123"
max_terminals: 5
is_active: true
```

**activations table**:

```
id: "987fcdeb-51a2-43f1-b789-123456789abc"
license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"  ← Links to license
machine_id_hash: "MF2-a1b2c3d4e5f6..."         ← Machine fingerprint
terminal_name: "Main Terminal"
is_active: true
first_activation: "2024-01-15T10:30:00Z"
last_heartbeat: "2024-01-15T14:22:00Z"
```

**The activation record proves**: License key `AUR-PRO-V2-7A83B2D4-1F2E3D4C` is activated on machine with fingerprint `MF2-a1b2c3d4e5f6...`

---

## License Key Generation (WEB)

### When and Where

**Location**: `web/lib/license/generator.ts` → `generateLicenseKey()`

**Triggered By**:

1. **Primary**: Stripe webhook when customer completes payment

   - File: `web/app/api/stripe/webhooks/handler/route.ts` (lines 290-367)
   - Webhook event: `checkout.session.completed` or `customer.subscription.created`

2. **Secondary**: Manual subscription sync
   - File: `web/app/api/stripe/subscriptions/sync/route.ts`

### Generation Algorithm

```typescript
// web/lib/license/generator.ts (lines 20-33)
export function generateLicenseKey(planId: PlanId, customerId: string): string {
  // 1. Get plan code (BAS, PRO, ENT)
  const planCode = PLAN_CODES[planId]; // e.g., "PRO"

  // 2. Generate cryptographically secure random 8 chars
  const uniquePart = generateSecureRandom(8); // e.g., "7A83B2D4"

  // 3. Build base key (without signature)
  const baseKey = `AUR-${planCode}-${LICENSE_VERSION}-${uniquePart}`;
  // Result: "AUR-PRO-V2-7A83B2D4"

  // 4. Calculate HMAC signature using customerId as secret
  const signature = calculateHmacSignature(baseKey, customerId);
  // Result: "1F2E3D4C" (8 chars)

  // 5. Return complete key
  return `${baseKey}-${signature}`;
  // Final: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"
}
```

### License Key Components

**Format**: `AUR-{PlanCode}-V2-{Random}-{HMAC}`

**Example**: `AUR-PRO-V2-7A83B2D4-1F2E3D4C`

| Part      | Value      | Purpose                                        |
| --------- | ---------- | ---------------------------------------------- |
| Prefix    | `AUR`      | Fixed prefix (AuraSwift)                       |
| Plan Code | `PRO`      | BAS/PRO/ENT (plan tier)                        |
| Version   | `V2`       | License format version                         |
| Random    | `7A83B2D4` | Unique identifier (8 chars)                    |
| HMAC      | `1F2E3D4C` | Signature using customerId (tamper protection) |

### Storage in Database

```typescript
// web/lib/license/generator.ts → storeLicenseKey()
await db.insert(licenseKeys).values({
  customerId: customer.id, // Stripe customer ID
  subscriptionId: subscription.id, // Stripe subscription ID
  licenseKey: "AUR-PRO-V2-7A83B2D4-1F2E3D4C",
  maxTerminals: 5, // From plan features
  version: "V2",
  isActive: true,
  issuedAt: new Date(),
});
```

---

## Machine Fingerprinting (DESKTOP)

### Purpose

Create a **stable, unique identifier** for the Windows PC that:

- Doesn't change with minor software updates
- Is unique enough to identify the machine
- Can't be easily spoofed

### Location

**File**: `desktop/packages/main/src/utils/machineFingerprint.ts`  
**Function**: `generateMachineFingerprint()` (line 198)

### How It Works

```typescript
export function generateMachineFingerprint(): string {
  // 1. Collect stable hardware identifiers
  const identifiers = {
    diskSerial: getDiskSerial(), // Boot drive serial (very stable)
    windowsProductId: getWindowsProductId(), // Windows install ID (very stable)
    platform: "win32", // OS platform
    arch: "x64", // CPU architecture
    cpuModel: "Intel Core i7-9700K", // CPU model
    macAddresses: [
      // Sorted physical MACs
      "aa:bb:cc:dd:ee:ff",
      "11:22:33:44:55:66",
    ],
  };

  // 2. Build composite string (ordered by stability)
  const components = [
    identifiers.diskSerial, // Tier 1: Very stable
    identifiers.windowsProductId, // Tier 1: Very stable
    identifiers.platform, // Tier 2: Stable
    identifiers.arch, // Tier 2: Stable
    identifiers.cpuModel, // Tier 2: Stable
    ...identifiers.macAddresses.slice(0, 3), // Tier 3: Moderately stable
  ];

  const composite = components.join("|");
  // Result: "SN123456|12345-67890-ABCDE|win32|x64|Intel Core i7|aa:bb:cc:dd:ee:ff|..."

  // 3. Hash with SHA-256
  const hash = createHash("sha256").update(composite).digest("hex");
  // Result: "a1b2c3d4e5f6789..." (64 hex characters)

  // 4. Add version prefix
  return `MF2-${hash}`;
  // Final: "MF2-a1b2c3d4e5f6789..."
}
```

### Example Output

```
MF2-a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef1234567890
```

### When It's Generated

Desktop generates fingerprint in **three scenarios**:

1. **During activation** - When user enters license key
2. **During validation** - When checking if license is valid
3. **During heartbeat** - Regular check-ins (every startup + periodic)

---

## License Activation Flow (Complete)

### The Complete Journey: From Payment to Activated Desktop

### Phase 1: Customer Pays on Website (WEB)

**Step 1.1**: Customer selects plan and completes Stripe checkout

**Step 1.2**: Stripe sends webhook to `/api/stripe/webhooks/handler`

**Step 1.3**: Webhook handler generates license key

```typescript
// web/app/api/stripe/webhooks/handler/route.ts (lines 351-359)

// Generate license key
const licenseKey = generateLicenseKey(planId, customer.id);
// Result: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"

// Store in database
await storeLicenseKey(
  licenseKey,
  customer.id,
  subscription.id,
  planId,
  plan.features.maxTerminals // e.g., 5
);
```

**Database after Step 1.3**:

`license_keys` table:

```
license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"
customer_id: "cus_ABC123"
subscription_id: "sub_XYZ789"
max_terminals: 5
is_active: true
```

`activations` table:

```
(empty - no activations yet)
```

**Step 1.4**: Success page displays license key to customer

```typescript
// web/app/success/page.tsx
<LicenseKeyCard licenseKey="AUR-PRO-V2-7A83B2D4-1F2E3D4C" />
```

Customer **copies** license key: `AUR-PRO-V2-7A83B2D4-1F2E3D4C`

---

### Phase 2: Customer Opens Desktop App (DESKTOP)

**Step 2.1**: Customer opens AuraSwift desktop app on Windows PC

**Step 2.2**: App shows license activation screen

**Step 2.3**: Customer **pastes** license key and clicks "Activate"

**Step 2.4**: Desktop generates machine fingerprint

```typescript
// desktop/packages/main/src/ipc/license.handlers.ts (line 638)
const machineIdHash = generateMachineFingerprint();
// Result: "MF2-a1b2c3d4e5f6..."
```

**Step 2.5**: Desktop sends activation request to web API

```typescript
// desktop/packages/main/src/services/licenseService.ts (lines 334-373)

// Prepare request payload
const payload = {
  licenseKey: "AUR-PRO-V2-7A83B2D4-1F2E3D4C",
  machineIdHash: "MF2-a1b2c3d4e5f6...",
  terminalName: "Main Terminal",
  appVersion: "1.0.0",
  ipAddress: "192.168.1.100",
  location: {
    platform: "win32",
    arch: "x64",
  },
};

// Send POST request
const response = await fetch("https://auraswift.io/api/license/activate", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
});
```

---

### Phase 3: Web API Validates and Creates Activation (WEB)

**Step 3.1**: Web API receives request at `/api/license/activate`

```typescript
// web/app/api/license/activate/route.ts (line 15)
export async function POST(request: NextRequest) {
  const body = await request.json();
  // body = { licenseKey: "AUR-PRO-V2-...", machineIdHash: "MF2-...", ... }

  const result = await activateLicense(body);
  return NextResponse.json(result);
}
```

**Step 3.2**: Validator checks license key format

```typescript
// web/lib/license/validator.ts (lines 239-246)

// Validate format: AUR-XXX-V2-XXXXXXXX-XXXXXXXX
const formatValidation = validateLicenseKeyFormat(licenseKey);
if (!formatValidation.valid) {
  return { success: false, message: "Invalid license key format" };
}
```

**Step 3.3**: Start database transaction with row locking

```typescript
// web/lib/license/validator.ts (line 252)
return await db.transaction(async (tx) => {
  // All operations inside this transaction are atomic
```

**Step 3.4**: Find and LOCK license key record

```typescript
// web/lib/license/validator.ts (lines 254-259)

const [license] = await tx
  .select()
  .from(licenseKeys)
  .where(eq(licenseKeys.licenseKey, "AUR-PRO-V2-7A83B2D4-1F2E3D4C"))
  .for("update") // ← ROW-LEVEL LOCK (prevents race conditions)
  .limit(1);
```

**Database finds**:

```
id: "123e4567-..."
license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"
customer_id: "cus_ABC123"
max_terminals: 5
is_active: true
```

**Step 3.5**: Validate license status

```typescript
// web/lib/license/validator.ts (lines 269-294)

// Check 1: Is license active?
if (!license.isActive) {
  return { success: false, message: "License deactivated" };
}

// Check 2: Is license revoked?
if (license.revokedAt) {
  return { success: false, message: "License revoked" };
}

// Check 3: Is license expired?
if (license.expiresAt && new Date(license.expiresAt) < new Date()) {
  return { success: false, message: "License expired" };
}
```

**Step 3.6**: Check subscription status

```typescript
// web/lib/license/validator.ts (lines 296-324)

const [subscription] = await tx
  .select()
  .from(subscriptions)
  .where(eq(subscriptions.id, license.subscriptionId))
  .limit(1);

if (subscription.status === "cancelled" || subscription.status === "past_due") {
  return { success: false, message: "Subscription cancelled/past due" };
}
```

**Step 3.7**: Get existing activations for this license

```typescript
// web/lib/license/validator.ts (lines 337-347)

const existingActivations = await tx
  .select()
  .from(activations)
  .where(
    and(
      eq(activations.licenseKey, "AUR-PRO-V2-7A83B2D4-1F2E3D4C"),
      eq(activations.isActive, true)
    )
  )
  .for("update"); // Lock activation rows too
```

**Result**: Array of active activations (could be 0, 1, 2, etc.)

**Step 3.8**: Check if THIS MACHINE is already activated

```typescript
// web/lib/license/validator.ts (lines 349-384)

const existingMachineActivation = existingActivations.find(
  (a) => a.machineIdHash === "MF2-a1b2c3d4e5f6..."
);

if (existingMachineActivation) {
  // Same machine trying to activate again - just update heartbeat
  await tx
    .update(activations)
    .set({ lastHeartbeat: new Date() })
    .where(eq(activations.id, existingMachineActivation.id));

  return { success: true, message: "Already activated on this device" };
}
```

**Step 3.9**: Check terminal limit

```typescript
// web/lib/license/validator.ts (lines 386-408)

// Example: max_terminals = 5, existingActivations.length = 2
if (existingActivations.length >= license.maxTerminals) {
  // Check for grace period activations (within 24 hours)
  const graceActivation = existingActivations.find((a) => {
    const ageMs = Date.now() - new Date(a.firstActivation).getTime();
    return ageMs < 24 * 60 * 60 * 1000; // 24 hours
  });

  if (!graceActivation) {
    return {
      success: false,
      message: "Maximum terminal limit reached (5/5)",
    };
  }

  // Replace grace period activation
  await tx
    .update(activations)
    .set({ isActive: false })
    .where(eq(activations.id, graceActivation.id));
}
```

**Step 3.10**: Create new activation record (THE KEY LINK!)

```typescript
// web/lib/license/validator.ts (lines 410-423)

const [newActivation] = await tx
  .insert(activations)
  .values({
    licenseKey: "AUR-PRO-V2-7A83B2D4-1F2E3D4C", // ← Links to license key
    machineIdHash: "MF2-a1b2c3d4e5f6...", // ← Links to machine
    terminalName: "Main Terminal",
    firstActivation: new Date(),
    lastHeartbeat: new Date(),
    isActive: true,
    ipAddress: "192.168.1.100",
    location: { platform: "win32", arch: "x64" },
  })
  .returning();
```

**Database after Step 3.10**:

`activations` table NOW HAS:

```
id: "987fcdeb-51a2-43f1-b789-123456789abc"
license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"  ← LINKED TO LICENSE
machine_id_hash: "MF2-a1b2c3d4e5f6..."         ← LINKED TO MACHINE
terminal_name: "Main Terminal"
is_active: true
first_activation: "2024-01-15T10:30:00Z"
last_heartbeat: "2024-01-15T10:30:00Z"
```

**✅ THIS IS WHERE THE LICENSE KEY AND MACHINE FINGERPRINT ARE LINKED! ✅**

**Step 3.11**: Update activation count

```typescript
// web/lib/license/validator.ts (lines 425-431)

await tx
  .update(licenseKeys)
  .set({ activationCount: sql`${licenseKeys.activationCount} + 1` })
  .where(eq(licenseKeys.id, license.id));
```

**Step 3.12**: Commit transaction and return success

```typescript
// web/lib/license/validator.ts (lines 433-449)

return {
  success: true,
  message: "License activated successfully!",
  data: {
    activationId: "987fcdeb-51a2-43f1-b789-123456789abc",
    planId: "professional",
    planName: "Professional",
    maxTerminals: 5,
    currentActivations: 3,
    features: ["multi_terminal", "advanced_reporting", ...],
    expiresAt: null,
    subscriptionStatus: "active",
    businessName: "Acme Corp"
  }
};
```

---

### Phase 4: Desktop Receives Confirmation (DESKTOP)

**Step 4.1**: Desktop receives API response

```typescript
// desktop/packages/main/src/ipc/license.handlers.ts (line 643)
const result = await activateLicense({ licenseKey, terminalName });

if (result.success && result.data) {
  // Activation successful!
}
```

**Step 4.2**: Store activation locally in desktop database

```typescript
// desktop/packages/main/src/ipc/license.handlers.ts (lines 664-676)

await storeLocalActivation({
  licenseKey: "AUR-PRO-V2-7A83B2D4-1F2E3D4C",
  machineIdHash: "MF2-a1b2c3d4e5f6...",
  activationId: "987fcdeb-51a2-43f1-b789-123456789abc",
  planId: "professional",
  planName: "Professional",
  maxTerminals: 5,
  features: ["multi_terminal", "advanced_reporting", ...],
  businessName: "Acme Corp",
  subscriptionStatus: "active",
  expiresAt: null
});
```

**Step 4.3**: Initialize SSE connection for real-time updates

```typescript
// desktop/packages/main/src/ipc/license.handlers.ts (lines 725-728)

initializeSSE(
  "AUR-PRO-V2-7A83B2D4-1F2E3D4C",
  "MF2-a1b2c3d4e5f6...",
  "https://auraswift.io"
);
```

**Step 4.4**: Show success message to user

Desktop app now shows: **"✅ License activated successfully!"**

**Step 4.5**: App is now fully activated and operational

---

## License Validation Flow

### Purpose

Validate that a license is still valid and activated on this machine **without creating a new activation**.

### When Validation Happens

1. **App startup** - Check if locally stored activation is still valid
2. **Periodic checks** - Every few hours while app is running
3. **Before sensitive operations** - E.g., processing transactions

### Validation Process

**Step 1**: Desktop reads local activation

```typescript
const localActivation = await getLocalActivation();
// Result: { licenseKey: "AUR-PRO-V2-...", machineIdHash: "MF2-..." }
```

**Step 2**: Desktop generates current machine fingerprint

```typescript
const currentFingerprint = generateMachineFingerprint();
// Result: "MF2-a1b2c3d4e5f6..."
```

**Step 3**: Desktop sends validation request

```typescript
POST /api/license/validate
{
  licenseKey: "AUR-PRO-V2-7A83B2D4-1F2E3D4C",
  machineIdHash: "MF2-a1b2c3d4e5f6..."
}
```

**Step 4**: Web validates license

```typescript
// web/lib/license/validator.ts (lines 467-570)

export async function validateLicense(licenseKey, machineIdHash) {
  // 1. Find license
  const [license] = await db.select()
    .from(licenseKeys)
    .where(eq(licenseKeys.licenseKey, licenseKey));

  if (!license || !license.isActive) {
    return { success: false, message: "License invalid" };
  }

  // 2. Check if machine is activated
  const [activation] = await db.select()
    .from(activations)
    .where(
      and(
        eq(activations.licenseKey, licenseKey),
        eq(activations.machineIdHash, machineIdHash),  // ← MATCH!
        eq(activations.isActive, true)
      )
    );

  if (!activation) {
    return { success: false, message: "Not activated on this device" };
  }

  return {
    success: true,
    message: "License is valid",
    data: { isValid: true, planId: "professional", ... }
  };
}
```

**Step 5**: Desktop receives validation result

- **If valid**: Continue normal operation
- **If invalid**: Show license error and disable features

---

## Heartbeat and Ongoing Validation

### Purpose

Regular check-ins to:

1. Prove the app is still running and licensed
2. Check for subscription changes (cancellation, upgrades)
3. Update last activity timestamp

### Heartbeat Schedule

- **On app startup** - Immediate heartbeat
- **Every 4 hours** - While app is running
- **Before critical operations** - Optional additional checks

### Heartbeat Process

**Step 1**: Desktop sends heartbeat

```typescript
// desktop/packages/main/src/services/licenseService.ts (lines 459-514)

POST /api/license/heartbeat
{
  licenseKey: "AUR-PRO-V2-7A83B2D4-1F2E3D4C",
  machineIdHash: "MF2-a1b2c3d4e5f6...",
  appVersion: "1.0.0",
  sessionCount: 25,
  transactionCount: 142
}
```

**Step 2**: Web processes heartbeat

```typescript
// web/lib/license/validator.ts (lines 580-760)

export async function processHeartbeat(licenseKey, machineIdHash, metadata) {
  // 1. Find activation
  const [activation] = await db
    .select()
    .from(activations)
    .where(
      and(
        eq(activations.licenseKey, licenseKey),
        eq(activations.machineIdHash, machineIdHash),
        eq(activations.isActive, true)
      )
    );

  if (!activation) {
    return { success: false, data: { shouldDisable: true } };
  }

  // 2. Check subscription status
  const [subscription] = await db
    .select()
    .from(subscriptions)
    .where(eq(subscriptions.id, license.subscriptionId));

  let shouldDisable = false;

  if (subscription.status === "cancelled") {
    // Check grace period
    const gracePeriodEnd = new Date(
      subscription.canceledAt.getTime() + 7 * 24 * 60 * 60 * 1000
    );

    if (Date.now() > gracePeriodEnd) {
      shouldDisable = true; // Grace period expired
    }
  }

  // 3. Update heartbeat timestamp
  await db
    .update(activations)
    .set({ lastHeartbeat: new Date() })
    .where(eq(activations.id, activation.id));

  return {
    success: true,
    data: {
      isValid: !shouldDisable,
      shouldDisable,
      subscriptionStatus: subscription.status,
      gracePeriodRemaining: shouldDisable ? 0 : gracePeriodRemaining,
    },
  };
}
```

**Step 3**: Desktop acts on heartbeat result

```typescript
if (heartbeatResult.data.shouldDisable) {
  // Disable app features
  await disableLicense();
  showError("Subscription expired. Please renew.");
} else {
  // Continue normal operation
  continueOperation();
}
```

---

## How License Key and Machine Fingerprint are Linked

### The Activation Record is the Bridge

```
┌─────────────────────────────────────────────────────────────┐
│                    license_keys Table                        │
├─────────────────────────────────────────────────────────────┤
│ license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"                 │
│ customer_id: "cus_ABC123"                                    │
│ max_terminals: 5                                             │
│ is_active: true                                              │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ Referenced by
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                   activations Table                          │
├─────────────────────────────────────────────────────────────┤
│ license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C" ← LINK #1      │
│ machine_id_hash: "MF2-a1b2c3d4e5f6..."       ← LINK #2      │
│ terminal_name: "Main Terminal"                               │
│ is_active: true                                              │
│ first_activation: "2024-01-15T10:30:00Z"                    │
│ last_heartbeat: "2024-01-15T14:22:00Z"                      │
└─────────────────────────────────────────────────────────────┘

The activations table row means:
"License AUR-PRO-V2-... is activated on machine MF2-..."
```

### How Validation Uses This Link

When desktop validates:

```typescript
// Desktop asks: "Is license X valid on machine Y?"
validateLicense(
  "AUR-PRO-V2-7A83B2D4-1F2E3D4C",  // License key
  "MF2-a1b2c3d4e5f6..."             // Machine fingerprint
)

// Web checks: "Does an activation record exist with BOTH?"
SELECT * FROM activations
WHERE license_key = 'AUR-PRO-V2-7A83B2D4-1F2E3D4C'
  AND machine_id_hash = 'MF2-a1b2c3d4e5f6...'
  AND is_active = true;

// If found → Valid activation
// If not found → Not activated on this machine
```

### Multiple Machines Example

One license key can have multiple activations:

```
license_keys:
  license_key: "AUR-PRO-V2-7A83B2D4-1F2E3D4C"
  max_terminals: 5

activations:
  Row 1: license_key="AUR-PRO-V2-...", machine_id_hash="MF2-machine1..."
  Row 2: license_key="AUR-PRO-V2-...", machine_id_hash="MF2-machine2..."
  Row 3: license_key="AUR-PRO-V2-...", machine_id_hash="MF2-machine3..."

Result: Same license activated on 3 different machines (3/5 terminals used)
```

---

## Code Flow Walkthrough

### Complete Code Path: User Enters License Key → Activated

#### 1. User Enters License Key in Desktop App

**File**: `desktop/packages/renderer/src/features/license/components/activation-form.tsx`

User types: `AUR-PRO-V2-7A83B2D4-1F2E3D4C`  
User clicks: "Activate License"

#### 2. IPC Call to Main Process

**File**: `desktop/packages/renderer/src/features/license/hooks/use-license.ts`

```typescript
const result = await window.electron.ipcRenderer.invoke(
  "license:activate",
  licenseKey,
  terminalName
);
```

#### 3. Main Process Generates Fingerprint

**File**: `desktop/packages/main/src/ipc/license.handlers.ts` (lines 634-646)

```typescript
ipcMain.handle('license:activate', async (event, licenseKey, terminalName) => {
  // Generate machine fingerprint
  const machineIdHash = generateMachineFingerprint();
  // Result: "MF2-a1b2c3d4e5f6..."

  // Call activation API
  const result = await activateLicense({ licenseKey, terminalName });
  ...
});
```

#### 4. HTTP Request to Web API

**File**: `desktop/packages/main/src/services/licenseService.ts` (lines 334-398)

```typescript
export async function activateLicense(request) {
  const machineIdHash = generateMachineFingerprint();
  const machineInfo = getMachineInfo();

  const result = await makeRequest("activate", {
    method: "POST",
    body: {
      licenseKey: request.licenseKey,
      machineIdHash,
      terminalName: request.terminalName || "Terminal",
      appVersion: app.getVersion(),
      location: { platform: machineInfo.platform, arch: machineInfo.arch },
    },
  });

  return result;
}
```

#### 5. Web API Receives Request

**File**: `web/app/api/license/activate/route.ts` (lines 15-77)

```typescript
export async function POST(request: NextRequest) {
  const body = await request.json();
  const { licenseKey, machineIdHash, terminalName } = body;

  const result = await activateLicense({
    licenseKey,
    machineIdHash,
    terminalName,
    ...
  });

  return NextResponse.json(result);
}
```

#### 6. Validation Logic

**File**: `web/lib/license/validator.ts` (lines 233-458)

```typescript
export async function activateLicense(request) {
  return await db.transaction(async (tx) => {
    // 1. Find and lock license
    const [license] = await tx.select()
      .from(licenseKeys)
      .where(eq(licenseKeys.licenseKey, request.licenseKey))
      .for("update");

    // 2. Validate license
    if (!license.isActive) return { success: false };

    // 3. Check existing activations
    const existingActivations = await tx.select()
      .from(activations)
      .where(eq(activations.licenseKey, request.licenseKey));

    // 4. Check if already activated on this machine
    const existingMachine = existingActivations.find(
      a => a.machineIdHash === request.machineIdHash
    );
    if (existingMachine) {
      // Update heartbeat and return success
      await tx.update(activations)
        .set({ lastHeartbeat: new Date() })
        .where(eq(activations.id, existingMachine.id));
      return { success: true, message: "Already activated" };
    }

    // 5. Check terminal limit
    if (existingActivations.length >= license.maxTerminals) {
      return { success: false, message: "Max terminals reached" };
    }

    // 6. Create activation record (THE KEY LINKAGE!)
    const [newActivation] = await tx.insert(activations).values({
      licenseKey: request.licenseKey,
      machineIdHash: request.machineIdHash,
      terminalName: request.terminalName,
      firstActivation: new Date(),
      lastHeartbeat: new Date(),
      isActive: true
    }).returning();

    return { success: true, data: { activationId: newActivation.id, ... } };
  });
}
```

#### 7. Response Returns to Desktop

**File**: `desktop/packages/main/src/ipc/license.handlers.ts` (lines 664-720)

```typescript
if (result.success && result.data) {
  // Store activation locally
  await storeLocalActivation({
    licenseKey,
    machineIdHash,
    activationId: result.data.activationId,
    planId: result.data.planId,
    ...
  });

  // Initialize SSE
  initializeSSE(licenseKey, machineIdHash, apiBaseUrl);

  return { success: true, message: "License activated!" };
}
```

#### 8. UI Shows Success

**File**: `desktop/packages/renderer/src/features/license/components/activation-form.tsx`

```typescript
if (result.success) {
  showNotification("✅ License activated successfully!");
  navigate("/dashboard");
}
```

---

## Summary: The Complete Flow

### Data Created at Each Stage

1. **Customer Pays** → `license_keys` record created
2. **Customer Activates** → `activations` record created (links license + machine)
3. **Desktop Starts** → Validation checks `activations` table for matching record
4. **Periodic Heartbeat** → Updates `last_heartbeat` in `activations` table

### The Critical Link

**The `activations` table row is the link:**

```sql
-- This single row means:
-- "License AUR-PRO-V2-... is activated on machine MF2-..."

INSERT INTO activations (
  license_key,              -- From WEB (generated at payment)
  machine_id_hash,          -- From DESKTOP (generated at activation)
  is_active
) VALUES (
  'AUR-PRO-V2-7A83B2D4-1F2E3D4C',
  'MF2-a1b2c3d4e5f6...',
  true
);
```

### Key Takeaways

1. **License keys are generated ONLY in WEB** - Never in desktop
2. **Machine fingerprints are generated ONLY in DESKTOP** - Never in web
3. **The link happens in the `activations` table** - Created by web when desktop activates
4. **Validation = checking if activation record exists** - With matching license key AND machine fingerprint
5. **One license can have multiple activations** - Up to `max_terminals` limit
6. **Heartbeat maintains the activation** - Updates last_heartbeat timestamp

---

## Files Reference

### WEB Project (License Generation & Validation)

| File                                           | Purpose                                     |
| ---------------------------------------------- | ------------------------------------------- |
| `web/lib/license/generator.ts`                 | Generate license keys                       |
| `web/lib/license/validator.ts`                 | Activate, validate, heartbeat logic         |
| `web/lib/db/schema.ts`                         | Database schema (license_keys, activations) |
| `web/app/api/license/activate/route.ts`        | Activation API endpoint                     |
| `web/app/api/license/validate/route.ts`        | Validation API endpoint                     |
| `web/app/api/license/heartbeat/route.ts`       | Heartbeat API endpoint                      |
| `web/app/api/stripe/webhooks/handler/route.ts` | Webhook triggers license generation         |

### DESKTOP Project (Machine Fingerprinting & Activation)

| File                                                    | Purpose                             |
| ------------------------------------------------------- | ----------------------------------- |
| `desktop/packages/main/src/utils/machineFingerprint.ts` | Generate machine fingerprints       |
| `desktop/packages/main/src/services/licenseService.ts`  | HTTP client for license API         |
| `desktop/packages/main/src/ipc/license.handlers.ts`     | IPC handlers for license operations |
| `desktop/packages/renderer/src/features/license/`       | UI for license activation           |

---

## Conclusion

**License keys** are generated by the WEB project when customers pay. They are **stored in the `license_keys` table**.

**Machine fingerprints** are generated by the DESKTOP project when users activate. They are **never stored alone** - only as part of an activation record.

**The `activations` table creates the link** between license keys and machine fingerprints. Each row means "license X is activated on machine Y".

**Validation works by checking**: Does an activation record exist with this license key AND this machine fingerprint? If yes → valid. If no → not activated.

The two projects work together seamlessly: Web manages licenses, Desktop generates fingerprints, and the activation record in the web database links them together.
