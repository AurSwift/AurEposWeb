# API Architecture Documentation

**Last Updated:** January 9, 2025  
**Status:** Current architecture documentation

---

## System Overview

The Aurswift API implements a dual hybrid architecture combining:

- **Direct API routes** for user-initiated, synchronous operations
- **Webhook routes** for Stripe-initiated, asynchronous event processing
- **Real-time event streaming** via Server-Sent Events (SSE) for desktop app synchronization

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WEB APPLICATION                                    â”‚
â”‚                         (Next.js API Routes)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                         â”‚
        â–¼                                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INTERFACE   â”‚                                   â”‚   STRIPE CLOUD    â”‚
â”‚   (Dashboard)     â”‚                                   â”‚   (Webhooks)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                                         â”‚
        â”‚ User Actions                                            â”‚ Automatic Events
        â”‚ (Immediate)                                             â”‚ (Background)
        â”‚                                                         â”‚
        â–¼                                                         â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API LAYER (/app/api/)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   DIRECT API ROUTES            â”‚   â”‚   WEBHOOK ROUTE                 â”‚  â”‚
â”‚  â”‚   (User-Initiated)             â”‚   â”‚   (Stripe-Initiated)            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚  /subscriptions/               â”‚   â”‚  /stripe/webhooks/handler/     â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ cancel/                  â”‚   â”‚   â”œâ”€â”€ checkout.completed        â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ reactivate/              â”‚   â”‚   â”œâ”€â”€ subscription.updated      â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ change-plan/             â”‚   â”‚   â”œâ”€â”€ subscription.deleted      â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ preview-change/          â”‚   â”‚   â”œâ”€â”€ invoice.payment_succeeded â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ current/                 â”‚   â”‚   â”œâ”€â”€ invoice.payment_failed    â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ history/                 â”‚   â”‚   â”œâ”€â”€ customer.updated          â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ billing-history/         â”‚   â”‚   â”œâ”€â”€ payment_method.*          â”‚  â”‚
â”‚  â”‚   â””â”€â”€ plans/                   â”‚   â”‚   â””â”€â”€ invoice.*                 â”‚  â”‚
â”‚  â”‚                                â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚  /stripe/                      â”‚   â”‚  /stripe/webhooks/replay/      â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ checkout/create/         â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ subscriptions/           â”‚   â”‚  Pattern: Event-driven          â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ sync/                    â”‚   â”‚  Async: 1-5 second delay        â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ billing/portal/          â”‚   â”‚  Purpose: Background sync       â”‚  â”‚
â”‚  â”‚   â””â”€â”€ billing/payment-method/  â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚                                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  Pattern: Request-Response     â”‚                                        â”‚
â”‚  â”‚  Sync: ~250ms response         â”‚                                        â”‚
â”‚  â”‚  Purpose: User feedback        â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   SUPPORTING ROUTES                                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /license/              Desktop app operations                       â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ activate/         Activate license                             â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ deactivate/       Deactivate license                           â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ validate/         Validate license                             â”‚   â”‚
â”‚  â”‚   â””â”€â”€ heartbeat/        Keep-alive signal                            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /events/               Real-time sync                               â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ [licenseKey]/     SSE endpoint                                 â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ [licenseKey]/missed/  Fetch missed events                      â”‚   â”‚
â”‚  â”‚   â””â”€â”€ acknowledge/      Event acknowledgment                         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /admin/                Administrative operations                    â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ customers/        Customer management                          â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ licenses/         License management                           â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ stats/            System statistics                            â”‚   â”‚
â”‚  â”‚   â””â”€â”€ support/          Support ticket management                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /analytics/            Analytics and reporting                      â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ health/           Health analytics                             â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ patterns/         Usage patterns                               â”‚   â”‚
â”‚  â”‚   â””â”€â”€ trends/           Usage trends                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /dlq/                  Dead Letter Queue                            â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ route.ts          List & stats                                 â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ retry/[eventId]/  Retry failed event                           â”‚   â”‚
â”‚  â”‚   â””â”€â”€ resolve/[eventId]/ Resolve failed event                        â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /monitoring/           System monitoring                            â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ event-durability/ Event durability metrics                     â”‚   â”‚
â”‚  â”‚   â””â”€â”€ health/           System health                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /cron/                 Scheduled background jobs                     â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ analytics/        Analytics processing                         â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ cleanup-events/   Event cleanup                                â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ detect-stale-sessions/  Stale session detection                â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ expiration-check/ Subscription expiration                      â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ health-monitoring/ Health monitoring                           â”‚   â”‚
â”‚  â”‚   â””â”€â”€ retry-events/     Event retry processing                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /payments/             Payment tracking                             â”‚   â”‚
â”‚  â”‚   â””â”€â”€ history/          Payment records                              â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /invoices/             Invoice management                           â”‚   â”‚
â”‚  â”‚   â””â”€â”€ history/          Invoice records                              â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /terminals/            Terminal management                          â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ route.ts          Get terminals                                â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ broadcast/        Broadcast to terminals                       â”‚   â”‚
â”‚  â”‚   â””â”€â”€ sync/             Sync terminal data                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /terminal-sessions/    Terminal session management                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /health/               Health check endpoints                       â”‚   â”‚
â”‚  â”‚   â””â”€â”€ sse/              SSE health check                             â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /releases/             Release management                           â”‚   â”‚
â”‚  â”‚   â””â”€â”€ latest/           Latest release info                          â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATABASE LAYER                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  PostgreSQL (Neon Cloud)                                                     â”‚
â”‚  â”œâ”€â”€ subscriptions         Subscription records                             â”‚
â”‚  â”œâ”€â”€ customers             Customer records                                 â”‚
â”‚  â”œâ”€â”€ licenseKeys           License keys                                     â”‚
â”‚  â”œâ”€â”€ activations           License activations per machine                  â”‚
â”‚  â”œâ”€â”€ payments              Payment records                                  â”‚
â”‚  â”œâ”€â”€ invoices              Invoice records                                  â”‚
â”‚  â”œâ”€â”€ subscriptionChanges   Audit trail                                      â”‚
â”‚  â”œâ”€â”€ webhookEvents         Webhook deduplication                            â”‚
â”‚  â”œâ”€â”€ subscriptionEvents    Events published to SSE                          â”‚
â”‚  â”œâ”€â”€ eventAcknowledgments  Desktop app acknowledgments                      â”‚
â”‚  â””â”€â”€ deadLetterQueue       Failed events for retry                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       REDIS (Event Distribution)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Redis Pub/Sub                                                               â”‚
â”‚  â”œâ”€â”€ Channels: license:{licenseKey}                                         â”‚
â”‚  â”œâ”€â”€ Publishers: Webhook handlers, Direct API routes                        â”‚
â”‚  â”œâ”€â”€ Subscribers: SSE endpoint connections                                  â”‚
â”‚  â””â”€â”€ Purpose: Distribute events across server instances                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DESKTOP APPS                                        â”‚
â”‚                      (Electron - SSE Clients)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Desktop Application                                                         â”‚
â”‚  â”œâ”€â”€ SSE Connection: GET /api/events/[licenseKey]                           â”‚
â”‚  â”œâ”€â”€ Event Processing: Receives real-time subscription updates              â”‚
â”‚  â”œâ”€â”€ Acknowledgment: POST /api/events/acknowledge                           â”‚
â”‚  â”œâ”€â”€ Missed Events: GET /api/events/[licenseKey]/missed                    â”‚
â”‚  â””â”€â”€ License Operations: /api/license/*                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Patterns

### Flow 1: User Cancels Subscription (Direct API)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  Dashboard  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Click "Cancel"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/subscriptions/cancel         â”‚
â”‚  (Direct API Route)                     â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. requireAuth()                   â”‚ â”‚â—„â”€â”€â”€ NextAuth.js
â”‚  â”‚ 2. getCustomerOrThrow()            â”‚ â”‚â—„â”€â”€â”€ Database
â”‚  â”‚ 3. stripe.subscriptions.cancel()   â”‚ â”‚â—„â”€â”€â”€ Stripe API
â”‚  â”‚ 4. db.update(subscriptions)        â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 5. db.update(licenseKeys)          â”‚ â”‚
â”‚  â”‚ 6. createSubscriptionEvent()       â”‚ â”‚
â”‚  â”‚ 7. publishToRedis(licenseKey)      â”‚ â”‚â”€â”€â–º Redis Pub/Sub
â”‚  â”‚ 8. Return success                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Success response (250ms)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚ Sees Successâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Event published to Redis
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Desktop    â”‚
â”‚    Apps     â”‚
â”‚ (via SSE)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Characteristics:**

- Synchronous flow
- Immediate user feedback (~250ms)
- Database updated immediately
- Event published to Redis for desktop apps
- Error handling visible to user

---

### Flow 2: Automatic Subscription Renewal (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stripe    â”‚
â”‚   Cloud     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Auto-charge customer
       â”‚ 2. Send webhook event
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/stripe/webhooks/handler      â”‚
â”‚  (Webhook Handler)                      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Verify signature                â”‚ â”‚
â”‚  â”‚ 2. Check idempotency (webhookEvents)â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 3. Parse event type                â”‚ â”‚
â”‚  â”‚ 4. invoice.payment_succeeded       â”‚ â”‚
â”‚  â”‚ 5. handlePaymentSucceeded()        â”‚ â”‚
â”‚  â”‚ 6. db.update(subscriptions)        â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 7. db.insert(payments)             â”‚ â”‚
â”‚  â”‚ 8. createSubscriptionEvent()       â”‚ â”‚
â”‚  â”‚ 9. publishToRedis(licenseKey)      â”‚ â”‚â”€â”€â–º Redis Pub/Sub
â”‚  â”‚ 10. markWebhookSuccess()           â”‚ â”‚
â”‚  â”‚ 11. Return 200 OK                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. 200 OK (1-5 seconds)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stripe    â”‚
â”‚   Cloud     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Event published to Redis
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Desktop    â”‚
â”‚    Apps     â”‚
â”‚ (via SSE)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Desktop processes event
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/events/acknowledge           â”‚
â”‚  (Event Acknowledgment)                 â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Record acknowledgment           â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 2. Update event status             â”‚ â”‚
â”‚  â”‚ 3. Return success                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Characteristics:**

- Asynchronous flow
- Background processing (1-5 second delay acceptable)
- Idempotency via `webhookEvents` table
- Event distribution via Redis
- Desktop acknowledgment tracking

---

### Flow 3: Real-Time Event Streaming (SSE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Desktop    â”‚
â”‚    App      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Connect to SSE endpoint
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /api/events/[licenseKey]           â”‚
â”‚  (SSE Endpoint)                         â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Validate license key            â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 2. Create SSE connection           â”‚ â”‚
â”‚  â”‚ 3. Subscribe to Redis channel      â”‚ â”‚â—„â”€â”€â”€ Redis
â”‚  â”‚    "license:{licenseKey}"          â”‚ â”‚
â”‚  â”‚ 4. Send initial connection event   â”‚ â”‚
â”‚  â”‚ 5. Start heartbeat (30s interval)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Connection established
       â”‚
       â”‚ (Connection remains open)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event Published (from any route)       â”‚
â”‚                                          â”‚
â”‚  createSubscriptionEvent()               â”‚
â”‚    â””â”€> publishToRedis(licenseKey, event)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Redis broadcasts to subscribers
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSE Endpoint Receives Redis Event      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Receive event from Redis        â”‚ â”‚
â”‚  â”‚ 2. Format as SSE message           â”‚ â”‚
â”‚  â”‚ 3. Send to connected client        â”‚ â”‚
â”‚  â”‚ 4. Client processes event          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Desktop processes event
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/events/acknowledge           â”‚
â”‚                                          â”‚
â”‚  { eventId, licenseKey, status }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Characteristics:**

- Persistent connection
- Real-time event delivery (< 100ms)
- Redis pub/sub for multi-instance support
- Heartbeat mechanism (30s interval)
- Connection timeout (5 minutes of inactivity)
- Acknowledgment tracking

---

## Route Classification Matrix

### By Initiation Type

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER-INITIATED ROUTES                          â”‚
â”‚                    (Direct API - Immediate)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Category: Subscriptions                                           â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/cancel          âš¡ ~250ms                â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/reactivate      âš¡ ~250ms                â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/change-plan     âš¡ ~250ms                â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/preview-change  âš¡ ~400ms                â”‚
â”‚  â”œâ”€â”€ GET  /subscriptions/current         âš¡ ~100ms                â”‚
â”‚  â”œâ”€â”€ GET  /subscriptions/history         âš¡ ~150ms                â”‚
â”‚  â”œâ”€â”€ GET  /subscriptions/billing-history âš¡ ~150ms                â”‚
â”‚  â””â”€â”€ GET  /subscriptions/plans           âš¡ ~100ms                â”‚
â”‚                                                                    â”‚
â”‚  Category: Stripe                                                  â”‚
â”‚  â”œâ”€â”€ POST /stripe/checkout/create        âš¡ ~300ms                â”‚
â”‚  â”œâ”€â”€ POST /stripe/subscriptions          âš¡ ~400ms                â”‚
â”‚  â”œâ”€â”€ POST /stripe/sync                   âš¡ ~500ms                â”‚
â”‚  â”œâ”€â”€ POST /stripe/billing/portal         âš¡ ~200ms                â”‚
â”‚  â””â”€â”€ GET  /stripe/billing/payment-method âš¡ ~250ms                â”‚
â”‚                                                                    â”‚
â”‚  Category: License                                                 â”‚
â”‚  â”œâ”€â”€ POST /license/activate              âš¡ ~300ms                â”‚
â”‚  â”œâ”€â”€ POST /license/deactivate            âš¡ ~250ms                â”‚
â”‚  â”œâ”€â”€ POST /license/validate              âš¡ ~200ms                â”‚
â”‚  â””â”€â”€ POST /license/heartbeat             âš¡ ~150ms                â”‚
â”‚                                                                    â”‚
â”‚  Category: Admin                                                   â”‚
â”‚  â”œâ”€â”€ GET  /admin/customers               âš¡ ~200ms                â”‚
â”‚  â”œâ”€â”€ GET  /admin/stats                   âš¡ ~300ms                â”‚
â”‚  â”œâ”€â”€ POST /admin/licenses/[id]/revoke    âš¡ ~250ms                â”‚
â”‚  â””â”€â”€ POST /admin/support/[id]/respond    âš¡ ~200ms                â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STRIPE-INITIATED ROUTES                          â”‚
â”‚                    (Webhook - Background)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Route: /stripe/webhooks/handler                                   â”‚
â”‚                                                                    â”‚
â”‚  Events Handled:                                                   â”‚
â”‚  â”œâ”€â”€ checkout.session.completed          ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ customer.subscription.updated       ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ customer.subscription.deleted       ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ invoice.payment_succeeded           ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ invoice.payment_failed              ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ customer.updated                    ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ customer.deleted                    ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ payment_method.attached             ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ payment_method.detached             ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ invoice.created                     ğŸ•’ 1-5s                 â”‚
â”‚  â”œâ”€â”€ invoice.updated                     ğŸ•’ 1-5s                 â”‚
â”‚  â””â”€â”€ invoice.paid                        ğŸ•’ 1-5s                 â”‚
â”‚                                                                    â”‚
â”‚  Route: /stripe/webhooks/replay                                    â”‚
â”‚  â””â”€â”€ POST (replay webhook events)        ğŸ•’ Variable             â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   REAL-TIME SYNC ROUTES                            â”‚
â”‚                    (SSE - Push Notifications)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Route: /events/[licenseKey]                                       â”‚
â”‚  â”œâ”€â”€ GET                              ğŸ“¡ Real-time (< 100ms)      â”‚
â”‚  â””â”€â”€ GET  /events/[licenseKey]/missed ğŸ“¡ ~150ms                   â”‚
â”‚                                                                    â”‚
â”‚  Route: /events/acknowledge                                        â”‚
â”‚  â”œâ”€â”€ POST (acknowledge event)          âš¡ ~200ms                  â”‚
â”‚  â””â”€â”€ GET  (get acknowledgment status)  âš¡ ~150ms                  â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   BACKGROUND JOB ROUTES                            â”‚
â”‚                    (Cron - Scheduled Tasks)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Route: /cron/*                                                    â”‚
â”‚  â”œâ”€â”€ GET  /cron/analytics              â° Scheduled               â”‚
â”‚  â”œâ”€â”€ GET  /cron/cleanup-events         â° Scheduled               â”‚
â”‚  â”œâ”€â”€ GET  /cron/detect-stale-sessions  â° Scheduled               â”‚
â”‚  â”œâ”€â”€ GET  /cron/expiration-check       â° Scheduled               â”‚
â”‚  â”œâ”€â”€ POST /cron/expiration-check       â° Manual trigger          â”‚
â”‚  â”œâ”€â”€ GET  /cron/health-monitoring      â° Scheduled               â”‚
â”‚  â””â”€â”€ GET  /cron/retry-events           â° Scheduled               â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHENTICATION LAYER                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  NextAuth.js Session                                         â”‚
â”‚  â”œâ”€â”€ JWT tokens                                              â”‚
â”‚  â”œâ”€â”€ Session validation                                      â”‚
â”‚  â””â”€â”€ Role-based access control                               â”‚
â”‚                                                              â”‚
â”‚  Applied to:                                                 â”‚
â”‚  â”œâ”€â”€ All /subscriptions/* routes                            â”‚
â”‚  â”œâ”€â”€ All /stripe/* routes (except webhooks)                 â”‚
â”‚  â”œâ”€â”€ All /admin/* routes                                    â”‚
â”‚  â”œâ”€â”€ All /analytics/* routes                                â”‚
â”‚  â”œâ”€â”€ All /payments/* routes                                 â”‚
â”‚  â”œâ”€â”€ All /invoices/* routes                                 â”‚
â”‚  â”œâ”€â”€ All /profile/* routes                                  â”‚
â”‚  â””â”€â”€ All /user/* routes                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHORIZATION LAYER                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Customer Ownership Validation                               â”‚
â”‚  â”œâ”€â”€ requireAuth() - Session validation helper              â”‚
â”‚  â”œâ”€â”€ getCustomerOrThrow() - Customer lookup helper          â”‚
â”‚  â”œâ”€â”€ Verify subscription belongs to user                    â”‚
â”‚  â”œâ”€â”€ Verify license belongs to customer                     â”‚
â”‚  â””â”€â”€ Verify payment/invoice belongs to customer             â”‚
â”‚                                                              â”‚
â”‚  Admin Role Validation                                       â”‚
â”‚  â”œâ”€â”€ Admin-only routes require admin role                   â”‚
â”‚  â””â”€â”€ Applied to: /admin/*, /monitoring/*                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK VERIFICATION                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Stripe Signature Verification                               â”‚
â”‚  â”œâ”€â”€ STRIPE_WEBHOOK_SECRET (env var)                        â”‚
â”‚  â”œâ”€â”€ stripe.webhooks.constructEvent()                       â”‚
â”‚  â””â”€â”€ Signature validation from request headers              â”‚
â”‚                                                              â”‚
â”‚  Idempotency Check                                           â”‚
â”‚  â”œâ”€â”€ webhookEvents table                                    â”‚
â”‚  â”œâ”€â”€ Event ID from Stripe                                   â”‚
â”‚  â”œâ”€â”€ ON CONFLICT DO NOTHING                                 â”‚
â”‚  â””â”€â”€ Event deduplication                                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LICENSE VALIDATION                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  License Key + Machine Fingerprint                           â”‚
â”‚  â”œâ”€â”€ License key validation                                 â”‚
â”‚  â”œâ”€â”€ Machine ID hash validation                             â”‚
â”‚  â”œâ”€â”€ Activation status check                                â”‚
â”‚  â””â”€â”€ Expiration date check                                  â”‚
â”‚                                                              â”‚
â”‚  Applied to:                                                 â”‚
â”‚  â”œâ”€â”€ /license/* routes                                      â”‚
â”‚  â”œâ”€â”€ /events/[licenseKey] SSE endpoint                      â”‚
â”‚  â””â”€â”€ /events/acknowledge (with licenseKey)                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Strategy

### Direct API Routes (User-Initiated)

**Error Flow:**

1. Error caught in route handler
2. Error logged with context
3. User-friendly error message returned
4. Appropriate HTTP status code (400, 404, 500)
5. User sees error immediately

**Example:**

```typescript
try {
  await stripe.subscriptions.cancel(id);
  await db.update(subscriptions).set({...});
  return successResponse({...});
} catch (error) {
  return handleApiError(error, "Failed to cancel subscription");
}
```

### Webhook Routes (Stripe-Initiated)

**Error Flow:**

1. Error caught in webhook handler
2. Error logged with event details
3. Event marked as failed in `webhookEvents` table
4. If retriable: Return 500 to trigger Stripe retry
5. If max retries exceeded: Event enters Dead Letter Queue
6. Stripe automatically retries (with exponential backoff)

**Example:**

```typescript
try {
  await handleSubscriptionUpdated(subscription);
  await markWebhookSuccess(event.id);
  return NextResponse.json({ received: true });
} catch (error) {
  const shouldRetry = shouldRetryError(error);
  await logWebhookError(event.id, error, shouldRetry);

  if (shouldRetry) {
    return NextResponse.json(
      { error: "Webhook processing failed" },
      { status: 500 }
    );
  } else {
    // Move to DLQ
    await moveToDeadLetterQueue(event);
    return NextResponse.json({ received: true });
  }
}
```

### SSE Routes (Real-Time Streaming)

**Error Flow:**

1. Connection errors handled gracefully
2. Client automatically reconnects
3. Missed events fetched on reconnection
4. Heartbeat failures trigger reconnection
5. Connection timeout closes gracefully

---

## Event Durability & Reliability

### Event Acknowledgment System

**Purpose:** Track which events were successfully processed by desktop apps

**Flow:**

1. Event published to Redis â†’ SSE endpoint
2. Desktop app receives event via SSE
3. Desktop app processes event
4. Desktop app sends acknowledgment: `POST /api/events/acknowledge`
5. Acknowledgment recorded in `eventAcknowledgments` table
6. Monitoring tracks unacknowledged events

### Dead Letter Queue (DLQ)

**Purpose:** Handle events that failed after maximum retry attempts

**Operations:**

- `GET /api/dlq` - List DLQ items
- `GET /api/dlq?stats=true` - Get DLQ statistics
- `POST /api/dlq/retry/[eventId]` - Retry failed event
- `POST /api/dlq/resolve/[eventId]` - Mark as resolved

**DLQ Population:**

- Webhook processing failures (after max retries)
- SSE delivery failures (after max attempts)
- Desktop processing failures (acknowledged with `status: "failed"`)

### Retry Mechanism

**Automatic Retries:**

- Stripe webhook retries (automatic, exponential backoff)
- Cron job retry processing: `/cron/retry-events`
- SSE event retry via missed events endpoint

**Manual Retries:**

- DLQ retry endpoint
- Webhook replay endpoint: `/stripe/webhooks/replay`

---

## Monitoring & Observability

### Health Monitoring

**Endpoints:**

- `GET /api/monitoring/health` - System health status
- `GET /api/monitoring/event-durability` - Event durability metrics
- `GET /api/health/sse` - SSE connection health

**Metrics Tracked:**

- Webhook processing success rate
- Event acknowledgment rate
- DLQ size and age
- SSE connection count
- Average response times

### Scheduled Health Checks

**Cron Jobs:**

- `/cron/health-monitoring` - System health monitoring
- `/cron/detect-stale-sessions` - Detect stale SSE connections
- `/cron/cleanup-events` - Clean up old events

---

## Database Schema Overview

### Core Tables

- **`subscriptions`** - Active and historical subscription records
- **`customers`** - Customer records linked to users
- **`licenseKeys`** - License key definitions
- **`activations`** - License activations per machine
- **`payments`** - Payment transaction records
- **`invoices`** - Invoice records from Stripe
- **`subscriptionChanges`** - Audit trail of subscription modifications

### Event Tables

- **`subscriptionEvents`** - Events published to SSE clients
- **`eventAcknowledgments`** - Desktop app event acknowledgments
- **`webhookEvents`** - Webhook event deduplication and tracking
- **`deadLetterQueue`** - Failed events requiring manual intervention

### Audit & Tracking

- **`subscriptionChanges`** - Complete audit trail
- **`webhookEvents`** - Webhook processing history
- **`eventAcknowledgments`** - Desktop processing history

---

## Conclusion

The Aurswift API architecture provides:

1. **Clear separation** between user actions and automatic events
2. **Dual hybrid approach** for optimal performance and reliability
3. **Real-time synchronization** via SSE for desktop apps
4. **Event durability** with acknowledgment and retry mechanisms
5. **Comprehensive monitoring** for system health
6. **Scalable design** for future growth
7. **Security layers** at multiple levels
8. **Error handling** appropriate for each route type

---

**Last Updated:** January 9, 2025  
**Document Type:** Architecture Documentation  
**Version:** 2.0
