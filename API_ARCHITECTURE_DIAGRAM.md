# API Architecture Diagram - Dual Hybrid Approach

**Last Updated:** January 6, 2025 (Post-Migration)  
**Status:** âœ… Reflects current project structure after migration

---

## Visual Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WEB APPLICATION                                    â”‚
â”‚                         (Next.js API Routes)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                         â”‚
        â–¼                                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INTERFACE   â”‚                                   â”‚   STRIPE CLOUD    â”‚
â”‚   (Dashboard)     â”‚                                   â”‚   (Webhooks)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                                         â”‚
        â”‚ User Actions                                            â”‚ Automatic Events
        â”‚ (Immediate)                                             â”‚ (Background)
        â”‚                                                         â”‚
        â–¼                                                         â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API LAYER (/app/api/)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   DIRECT API ROUTES            â”‚   â”‚   WEBHOOK ROUTE                 â”‚  â”‚
â”‚  â”‚   (User-Initiated)             â”‚   â”‚   (Stripe-Initiated)            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚  /subscriptions/               â”‚   â”‚  /stripe/webhooks/handler/     â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ cancel/                  â”‚   â”‚   â”œâ”€â”€ checkout.completed        â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ reactivate/              â”‚   â”‚   â”œâ”€â”€ subscription.updated      â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ change-plan/             â”‚   â”‚   â”œâ”€â”€ subscription.deleted      â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ current/                 â”‚   â”‚   â”œâ”€â”€ invoice.payment_succeeded â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ history/                 â”‚   â”‚   â””â”€â”€ invoice.payment_failed    â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ billing-history/         â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚   â””â”€â”€ plans/                   â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚                                â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚  /stripe/                      â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ checkout/create/         â”‚   â”‚  Pattern: Event-driven          â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ subscriptions/sync/      â”‚   â”‚  Async: 1-5 second delay        â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ billing/portal/          â”‚   â”‚  Purpose: Background sync       â”‚  â”‚
â”‚  â”‚   â””â”€â”€ billing/payment-method/  â”‚   â”‚                                 â”‚  â”‚
â”‚  â”‚                                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  Pattern: Request-Response     â”‚                                        â”‚
â”‚  â”‚  Sync: ~250ms response         â”‚                                        â”‚
â”‚  â”‚  Purpose: User feedback        â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   SUPPORTING ROUTES                                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /license/              Desktop app operations                       â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ activate/         Activate license                             â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ deactivate/       Deactivate license                           â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ validate/         Validate license                             â”‚   â”‚
â”‚  â”‚   â””â”€â”€ heartbeat/        Keep-alive signal                            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /events/               Real-time sync                               â”‚   â”‚
â”‚  â”‚   â””â”€â”€ [licenseKey]/     SSE endpoint                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /payments/             Payment tracking                             â”‚   â”‚
â”‚  â”‚   â””â”€â”€ history/          Payment records                              â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  /terminals/            Terminal management                          â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATABASE LAYER                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  PostgreSQL (Neon Cloud)                                                     â”‚
â”‚  â”œâ”€â”€ subscriptions         Subscription records                              â”‚
â”‚  â”œâ”€â”€ customers             Customer records                                  â”‚
â”‚  â”œâ”€â”€ licenseKeys           License keys                                      â”‚
â”‚  â”œâ”€â”€ payments              Payment records                                   â”‚
â”‚  â”œâ”€â”€ subscriptionChanges   Audit trail                                       â”‚
â”‚  â””â”€â”€ webhookEvents         Webhook deduplication                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DESKTOP APPS                                        â”‚
â”‚                      (Electron - SSE Clients)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow Diagrams

### Flow 1: User Cancels Subscription (Direct API)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  Dashboard  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Click "Cancel"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/subscriptions/cancel         â”‚
â”‚  (Direct API Route)                     â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Validate request                â”‚ â”‚
â”‚  â”‚ 2. stripe.subscriptions.cancel()   â”‚ â”‚â—„â”€â”€â”€ Stripe API
â”‚  â”‚ 3. db.update(subscriptions)        â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 4. db.update(licenseKeys)          â”‚ â”‚
â”‚  â”‚ 5. publishSSEEvent()               â”‚ â”‚â”€â”€â–º SSE Publisher
â”‚  â”‚ 6. Return success                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Success response (250ms)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚ Sees Successâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**

- âœ… Immediate user feedback
- âœ… Synchronous flow
- âœ… Error handling visible to user
- âœ… ~250ms response time

---

### Flow 2: Automatic Subscription Renewal (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stripe    â”‚
â”‚   Cloud     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Auto-charge customer
       â”‚ 2. Send webhook event
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/stripe/webhooks/handler      â”‚
â”‚  (Webhook Handler)                      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Verify signature                â”‚ â”‚
â”‚  â”‚ 2. Check idempotency               â”‚ â”‚
â”‚  â”‚ 3. Parse event type                â”‚ â”‚
â”‚  â”‚ 4. invoice.payment_succeeded       â”‚ â”‚
â”‚  â”‚ 5. db.update(subscriptions)        â”‚ â”‚â—„â”€â”€â”€ PostgreSQL
â”‚  â”‚ 6. db.insert(payments)             â”‚ â”‚
â”‚  â”‚ 7. publishSSEEvent()               â”‚ â”‚â”€â”€â–º SSE Publisher
â”‚  â”‚ 8. Return 200 OK                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. 200 OK (1-5 seconds)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stripe    â”‚
â”‚   Cloud     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. SSE notification
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Desktop    â”‚
â”‚    Apps     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**

- âœ… No user waiting
- âœ… Asynchronous flow
- âœ… Automatic processing
- âœ… 1-5 second delay acceptable

---

## Route Classification Matrix

### By Initiation Type

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER-INITIATED ROUTES                          â”‚
â”‚                    (Direct API - Immediate)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Category: Subscriptions                                           â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/cancel          âš¡ Fast: 250ms           â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/reactivate      âš¡ Fast: 250ms           â”‚
â”‚  â”œâ”€â”€ POST /subscriptions/change-plan     âš¡ Fast: 250ms           â”‚
â”‚  â”œâ”€â”€ GET  /subscriptions/current         âš¡ Fast: 100ms           â”‚
â”‚  â”œâ”€â”€ GET  /subscriptions/history         âš¡ Fast: 150ms           â”‚
â”‚  â”œâ”€â”€ GET  /subscriptions/billing-history âš¡ Fast: 150ms           â”‚
â”‚  â””â”€â”€ GET  /subscriptions/plans           âš¡ Fast: 100ms           â”‚
â”‚                                                                    â”‚
â”‚  Category: Stripe                                                  â”‚
â”‚  â”œâ”€â”€ POST /stripe/checkout/create        âš¡ Fast: 300ms           â”‚
â”‚  â”œâ”€â”€ POST /stripe/subscriptions/sync     âš¡ Fast: 400ms           â”‚
â”‚  â”œâ”€â”€ POST /stripe/billing/portal         âš¡ Fast: 200ms           â”‚
â”‚  â””â”€â”€ GET  /stripe/billing/payment-method  âš¡ Fast: 250ms           â”‚
â”‚                                                                    â”‚
â”‚  Category: License                                                 â”‚
â”‚  â”œâ”€â”€ POST /license/activate              âš¡ Fast: 300ms           â”‚
â”‚  â”œâ”€â”€ POST /license/deactivate            âš¡ Fast: 250ms           â”‚
â”‚  â”œâ”€â”€ POST /license/validate              âš¡ Fast: 200ms           â”‚
â”‚  â””â”€â”€ POST /license/heartbeat             âš¡ Fast: 150ms           â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STRIPE-INITIATED ROUTES                          â”‚
â”‚                    (Webhook - Background)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Route: /stripe/webhooks/handler                                   â”‚
â”‚                                                                    â”‚
â”‚  Events:                                                           â”‚
â”‚  â”œâ”€â”€ checkout.session.completed          ğŸ•’ Delay: 1-5s          â”‚
â”‚  â”œâ”€â”€ customer.subscription.updated       ğŸ•’ Delay: 1-5s          â”‚
â”‚  â”œâ”€â”€ customer.subscription.deleted       ğŸ•’ Delay: 1-5s          â”‚
â”‚  â”œâ”€â”€ invoice.payment_succeeded           ğŸ•’ Delay: 1-5s          â”‚
â”‚  â””â”€â”€ invoice.payment_failed              ğŸ•’ Delay: 1-5s          â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   REAL-TIME SYNC ROUTES                            â”‚
â”‚                    (SSE - Push Notifications)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Route: /events/[licenseKey]                                       â”‚
â”‚                                                                    â”‚
â”‚  Pattern: Server-Sent Events (SSE)                                 â”‚
â”‚  Purpose: Push notifications to desktop apps                       â”‚
â”‚  Latency: Real-time (< 100ms)                                      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Patterns

### Pattern 1: Optimistic Update (Direct API)

```
User Action â†’ Stripe API â†’ Database Update â†’ User Feedback
   (0ms)        (200ms)         (50ms)          (250ms)
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   Synchronous Transaction
```

**Benefits:**

- âœ… Immediate feedback
- âœ… Error handling
- âœ… Atomic transactions

---

### Pattern 2: Event-Driven Update (Webhook)

```
Stripe Event â†’ Webhook â†’ Database Update â†’ SSE Notification â†’ Desktop
   (0s)         (1-2s)       (0.1s)           (0.1s)          (1-3s)
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     Asynchronous Processing
```

**Benefits:**

- âœ… No user blocking
- âœ… Reliable delivery
- âœ… Retry mechanism

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHENTICATION LAYER                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  NextAuth.js Session                                         â”‚
â”‚  â”œâ”€â”€ JWT tokens                                              â”‚
â”‚  â”œâ”€â”€ Session validation                                      â”‚
â”‚  â””â”€â”€ Role-based access                                       â”‚
â”‚                                                              â”‚
â”‚  Applied to:                                                 â”‚
â”‚  â”œâ”€â”€ All /subscriptions/* routes                            â”‚
â”‚  â”œâ”€â”€ All /license/* routes                                  â”‚
â”‚  â”œâ”€â”€ All /payments/* routes                                 â”‚
â”‚  â””â”€â”€ All /stripe/* routes (except webhooks)                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHORIZATION LAYER                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Customer Ownership Validation                               â”‚
â”‚  â”œâ”€â”€ Verify subscription belongs to user                     â”‚
â”‚  â”œâ”€â”€ Verify license belongs to customer                      â”‚
â”‚  â””â”€â”€ Verify payment belongs to customer                      â”‚
â”‚                                                              â”‚
â”‚  Applied via:                                                â”‚
â”‚  â”œâ”€â”€ requireAuth() helper                                    â”‚
â”‚  â”œâ”€â”€ getCustomerOrThrow() helper                            â”‚
â”‚  â””â”€â”€ Database foreign key constraints                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK VERIFICATION                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Stripe Signature Verification                               â”‚
â”‚  â”œâ”€â”€ STRIPE_WEBHOOK_SECRET                                   â”‚
â”‚  â”œâ”€â”€ stripe.webhooks.constructEvent()                       â”‚
â”‚  â””â”€â”€ Signature validation                                    â”‚
â”‚                                                              â”‚
â”‚  Idempotency Check                                           â”‚
â”‚  â”œâ”€â”€ webhookEvents table                                     â”‚
â”‚  â”œâ”€â”€ ON CONFLICT DO NOTHING                                  â”‚
â”‚  â””â”€â”€ Event deduplication                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DIRECT API ROUTES                         â”‚
â”‚                  (User-Initiated Actions)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Error Flow:                                                 â”‚
â”‚  1. Catch error in route handler                             â”‚
â”‚  2. Log error details                                        â”‚
â”‚  3. Return user-friendly error message                       â”‚
â”‚  4. HTTP status code (400, 404, 500)                        â”‚
â”‚  5. User sees error immediately                              â”‚
â”‚                                                              â”‚
â”‚  Example:                                                    â”‚
â”‚  try {                                                       â”‚
â”‚    await stripe.subscriptions.cancel(id);                   â”‚
â”‚    await db.update(subscriptions).set({...});               â”‚
â”‚    return successResponse({...});                            â”‚
â”‚  } catch (error) {                                           â”‚
â”‚    return handleApiError(error, "Failed to cancel");        â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK ROUTE                             â”‚
â”‚                  (Stripe-Initiated Events)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Error Flow:                                                 â”‚
â”‚  1. Catch error in webhook handler                           â”‚
â”‚  2. Log error details                                        â”‚
â”‚  3. Mark event as failed in database                         â”‚
â”‚  4. Return 500 status to Stripe                              â”‚
â”‚  5. Stripe retries automatically                             â”‚
â”‚                                                              â”‚
â”‚  Example:                                                    â”‚
â”‚  try {                                                       â”‚
â”‚    await handleSubscriptionUpdated(subscription);            â”‚
â”‚    return NextResponse.json({ received: true });            â”‚
â”‚  } catch (error) {                                           â”‚
â”‚    // Mark event as failed                                   â”‚
â”‚    await db.update(webhookEvents)                            â”‚
â”‚      .set({ processed: false, error: String(error) });      â”‚
â”‚    return NextResponse.json(                                 â”‚
â”‚      { error: "Webhook handler failed" },                    â”‚
â”‚      { status: 500 }                                         â”‚
â”‚    );                                                        â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Conclusion

Your API architecture demonstrates:

1. âœ… **Clear separation** between user actions and automatic events
2. âœ… **Dual hybrid approach** properly implemented
3. âœ… **Intuitive folder structure** that matches URL patterns
4. âœ… **Security layers** at multiple levels
5. âœ… **Error handling** appropriate for each route type
6. âœ… **Real-time sync** via SSE for desktop apps
7. âœ… **Scalable design** for future growth

**Rating:** 9/10 - Excellent architecture! ğŸ‰

---

**Last Updated:** January 6, 2025 (Post-Migration Update)  
**Document Type:** Architecture Diagram  
**Migration Status:** âœ… Complete - Reflects current project structure
